function initWindowEvent(e){e.addEventListener("focus",function(){hideBar(e)})}function hideBar(e){var i=e.activity.actionBar;"undefined"!=typeof i&&i.hide()}function initWindow(){return Ti.UI.createWindow()}function initModule(){return require("ti.mapsforge")}function initMap(e,i){var r=i.createMapsforgeView({scalebar:!0,minZoom:5,maxZoom:20,centerLatlng:[-43.524551,172.58346],zoomLevel:14,debug:!1});return e.add(r),e.open(),r}function addOfflineMapLayer(e){e.addLayer({name:"osm",path:"osmdroid/maps/nz/nz.map"})}function initNav(e){e.load("/osmdroid/maps/nz/")}function initMapListener(e,i,r){Ti.App.addEventListener("viewCreated",function(){Ti.API.info("mapCreated: received by js"),addOfflineMapLayer(r),addActionListeners(i,r),initGPS()})}function addActionListeners(e,i){Ti.App.addEventListener("clicked",function(e){var i=(Ti.App.Android.R.drawable.marker_tap,[e.lat,e.lng]);Ti.API.info("clicked:"+i)}),Ti.App.addEventListener("longclicked",function(r){var n=[Ti.App.Properties.getDouble("lat"),Ti.App.Properties.getDouble("lng")],t=[r.lat,r.lng];if(Ti.API.info("longclicked:"+t),0==n[0]||0==n[1])Ti.API.info("GPS not available");else{navi(e,i,n,t),removePrevDestMarker(i);var a=Ti.App.Android.R.drawable.marker_tap_long,o=addMarker(i,t,a);Ti.App.Properties.setInt("dest",o)}})}function removePrevDestMarker(e){0!==Ti.App.Properties.getInt("dest")&&e.removeLayer(Ti.App.Properties.getInt("dest"));var i=Ti.App.Properties.getString("RouteMarkers");if(0!==i)for(var r=JSON.parse(i),n=0;n<r.length;n++)e.removeLayer(r[n])}function addMarker(e,i,r){var n=e.createMarker({iconPath:r,latlng:i});return n.id}function addNodeMarkers(){for(var e=Ti.App.Properties.getString("Nodes"),i=JSON.parse(e),r=[],n=0;n<i.length;n++){var t=i[n].pts[0],a=[t[1],t[0]],o=Ti.App.Android.R.drawable.point_red;Ti.API.info("point="+a);var d=addMarker(map,a,o);r.push(d)}Ti.App.Properties.setString("RouteMarkers",JSON.stringify(r))}function navi(e,i,r,n){var t={weighting:"fastest",vehicle:"car",from:r,to:n,debug:!1};e.getRouteAsyncCallback(t,function(e){if(0==e.error){var r=Ti.App.Properties.getInt("route");0!==r&&i.removeLayer(r);var n=i.createPolyline({latlngs:e.pts,color:"blue",strokeWidth:10});Ti.App.Properties.setInt("route",n.id),Ti.App.Properties.setString("Nodes",JSON.stringify(e.nodes)),addNodeMarkers()}else Ti.API.info("navi error:"+e.error)})}var win=initWindow();initWindowEvent(win);var mf=initModule(),map=initMap(win,mf);initMapListener(win,mf,map),initNav(mf);