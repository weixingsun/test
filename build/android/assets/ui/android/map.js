function initWindowEvent(e){e.addEventListener("focus",function(){hideBar(e);var i=createPopView();Ti.App.Properties.setObject("pop",i)})}function hideBar(e){var i=e.activity.actionBar;"undefined"!=typeof i&&i.hide()}function initWindow(){return Ti.UI.createWindow()}function initModule(){return require("ti.mapsforge")}function initMap(e,i){var n=Ti.App.Properties.getDouble("lng"),t=Ti.App.Properties.getDouble("lat"),r=i.createMapsforgeView({scalebar:!0,minZoom:5,maxZoom:20,centerLatlng:[t,n],zoomLevel:16,debug:!1});return e.add(r),e.open(),r}function addOfflineMapLayer(e){e.addLayer({name:"osm",path:"osmdroid/maps/nz/nz.map"})}function initNav(e){e.load("/osmdroid/maps/nz/")}function initMapListener(e,i,n){Ti.App.addEventListener("viewCreated",function(){Ti.API.info("mapCreated: received by js"),addOfflineMapLayer(n),addActionListeners(i,n),initGPS()})}function hidePopView(){var e=AllViews.pop;"undefined"!=typeof e&&e.hide()}function showPopView(){var e=AllViews.pop;"undefined"!=typeof e&&e.show()}function addActionListeners(e,i){Ti.App.addEventListener("clicked",function(e){var i=(Ti.App.Android.R.drawable.marker_tap,[e.lat,e.lng]);Ti.API.info("clicked:"+i);var n=AllViews.pop;n.visible?hidePopView():showPopView()}),Ti.App.addEventListener("longclicked",function(n){var t=[Ti.App.Properties.getDouble("lat"),Ti.App.Properties.getDouble("lng")],r=[n.lat,n.lng];if(Ti.API.info("longclicked:"+r),0==t[0]||0==t[1])Ti.API.info("GPS not available");else{navi(e,i,t,r),removePrevDestMarker(i);var o=Ti.App.Android.R.drawable.marker_tap_long,a=addMarker(i,r,o);Ti.App.Properties.setInt("dest",a)}})}function removePrevDestMarker(e){0!==Ti.App.Properties.getInt("dest")&&e.removeLayer(Ti.App.Properties.getInt("dest"));var i=Ti.App.Properties.getString("RouteMarkers");if(!(i.length<1))for(var n=JSON.parse(i),t=0;t<n.length;t++)e.removeLayer(n[t])}function addMarker(e,i,n){var t=e.createMarker({iconPath:n,latlng:i});return t.id}function addNodeMarkers(){for(var e=getNodes(),i=JSON.parse(e),n=[],t=0;t<i.length;t++){var r=i[t].pts[0],o=[r[1],r[0]],a=Ti.App.Android.R.drawable.point_red,d=addMarker(map,o,a);n.push(d)}Ti.App.Properties.setString("RouteMarkers",JSON.stringify(n))}function navi(e,i,n,t){var r={weighting:"fastest",vehicle:"foot",from:n,to:t};e.getRouteAsyncCallback(r,function(e){if(0==e.error){var n=Ti.App.Properties.getInt("route");0!==n&&i.removeLayer(n);var t=i.createPolyline({latlngs:e.pts,color:"blue",strokeWidth:10});Ti.App.Properties.setInt("route",t.id),Ti.App.Properties.setString("Nodes",JSON.stringify(e.nodes)),addNodeMarkers(),Ti.API.info("getRouteAsyncCallback().addNodeMarkers() done"),Ti.App.Properties.setInt("MODE",1),win.setKeepScreenOn(!0)}else Ti.API.info("navi error:"+e.error)})}function appEventListeners(){var e=Ti.Android.currentActivity;e.addEventListener("create",function(){Ti.API.info("*** Create Event Called ***")}),e.addEventListener("start",function(){Ti.API.info("*** Start Event Called ***")}),e.addEventListener("stop",function(){Ti.API.info("*** Stop Event Called ***"),hidePopView()}),e.addEventListener("resume",function(){Ti.API.info("*** Resume Event Called ***")}),e.addEventListener("pause",function(){Ti.API.info("*** Pause Event Called ***"),hidePopView()}),e.addEventListener("destroy",function(){Ti.API.info("*** Destroy Event Called ***")});var i=Ti.Android.createBroadcastReceiver({onReceived:function(){Ti.API.info("Handling broadcast ACTION_SCREEN_OFF."),hidePopView()}});Ti.Android.registerBroadcastReceiver(i,[Ti.Android.ACTION_SCREEN_OFF])}initVars();var win=initWindow();initWindowEvent(win);var mf=initModule(),map=initMap(win,mf);initMapListener(win,mf,map),initNav(mf),appEventListeners();