function initVars(){Ti.App.Properties.setInt("MODE",0),Ti.App.Properties.setString("Nodes",""),Ti.App.Properties.setInt("myCircle",0),Ti.App.Properties.setInt("mySpot",0)}function initWindowEvent(e){e.addEventListener("focus",function(){hideBar(e)})}function hideBar(e){var i=e.activity.actionBar;"undefined"!=typeof i&&i.hide()}function initWindow(){return Ti.UI.createWindow()}function initModule(){return require("ti.mapsforge")}function initMap(e,i){var r=i.createMapsforgeView({scalebar:!0,minZoom:5,maxZoom:20,centerLatlng:[-43.524551,172.58346],zoomLevel:14,debug:!1});return e.add(r),e.open(),r}function addOfflineMapLayer(e){e.addLayer({name:"osm",path:"osmdroid/maps/nz/nz.map"})}function initNav(e){e.load("/osmdroid/maps/nz/")}function initMapListener(e,i,r){Ti.App.addEventListener("viewCreated",function(){Ti.API.info("mapCreated: received by js"),addOfflineMapLayer(r),addActionListeners(i,r),initGPS()})}function addActionListeners(e,i){Ti.App.addEventListener("clicked",function(e){var i=(Ti.App.Android.R.drawable.marker_tap,[e.lat,e.lng]);Ti.API.info("clicked:"+i)}),Ti.App.addEventListener("longclicked",function(r){var t=[Ti.App.Properties.getDouble("lat"),Ti.App.Properties.getDouble("lng")],n=[r.lat,r.lng];if(Ti.API.info("longclicked:"+n),0==t[0]||0==t[1])Ti.API.info("GPS not available");else{navi(e,i,t,n),removePrevDestMarker(i);var a=Ti.App.Android.R.drawable.marker_tap_long,o=addMarker(i,n,a);Ti.App.Properties.setInt("dest",o)}})}function removePrevDestMarker(e){0!==Ti.App.Properties.getInt("dest")&&e.removeLayer(Ti.App.Properties.getInt("dest"));var i=Ti.App.Properties.getString("RouteMarkers");if(0!==i)for(var r=JSON.parse(i),t=0;t<r.length;t++)e.removeLayer(r[t])}function addMarker(e,i,r){var t=e.createMarker({iconPath:r,latlng:i});return t.id}function addNodeMarkers(){for(var e=Ti.App.Properties.getString("Nodes"),i=JSON.parse(e),r=[],t=0;t<i.length;t++){var n=i[t].pts[0],a=[n[1],n[0]],o=Ti.App.Android.R.drawable.point_red,p=addMarker(map,a,o);r.push(p)}Ti.App.Properties.setString("RouteMarkers",JSON.stringify(r))}function navi(e,i,r,t){var n={weighting:"fastest",vehicle:"car",from:r,to:t};e.getRouteAsyncCallback(n,function(e){if(0==e.error){var r=Ti.App.Properties.getInt("route");0!==r&&i.removeLayer(r);var t=i.createPolyline({latlngs:e.pts,color:"blue",strokeWidth:10});Ti.App.Properties.setInt("route",t.id),Ti.App.Properties.setString("Nodes",JSON.stringify(e.nodes)),addNodeMarkers()}else Ti.API.info("navi error:"+e.error)})}initVars();var win=initWindow();initWindowEvent(win);var mf=initModule(),map=initMap(win,mf);initMapListener(win,mf,map),initNav(mf);