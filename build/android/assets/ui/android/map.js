function initVars(){Ti.App.Properties.setInt("MODE",0),setNodes(""),Ti.App.Properties.setInt("myCircle",0),Ti.App.Properties.setInt("mySpot",0),Ti.App.Properties.setInt("dest",0),Ti.App.Properties.setInt("route",0),Ti.App.Properties.setString("RouteMarkers","")}function getNodes(){return Ti.App.Properties.getString("Nodes")}function setNodes(e){Ti.App.Properties.setString("Nodes",e)}function initWindowEvent(e){e.addEventListener("focus",function(){hideBar(e)})}function hideBar(e){var i=e.activity.actionBar;"undefined"!=typeof i&&i.hide()}function initWindow(){return Ti.UI.createWindow()}function initModule(){return require("ti.mapsforge")}function initMap(e,i){var t=Ti.App.Properties.getDouble("lng"),r=Ti.App.Properties.getDouble("lat"),n=i.createMapsforgeView({scalebar:!0,minZoom:5,maxZoom:20,centerLatlng:[r,t],zoomLevel:16,debug:!1});return e.add(n),e.open(),n}function addOfflineMapLayer(e){e.addLayer({name:"osm",path:"osmdroid/maps/nz/nz.map"})}function initNav(e){e.load("/osmdroid/maps/nz/")}function initMapListener(e,i,t){Ti.App.addEventListener("viewCreated",function(){Ti.API.info("mapCreated: received by js"),addOfflineMapLayer(t),addActionListeners(i,t),initGPS()})}function addActionListeners(e,i){Ti.App.addEventListener("clicked",function(e){var i=(Ti.App.Android.R.drawable.marker_tap,[e.lat,e.lng]);Ti.API.info("clicked:"+i)}),Ti.App.addEventListener("longclicked",function(t){var r=[Ti.App.Properties.getDouble("lat"),Ti.App.Properties.getDouble("lng")],n=[t.lat,t.lng];if(Ti.API.info("longclicked:"+n),0==r[0]||0==r[1])Ti.API.info("GPS not available");else{navi(e,i,r,n),removePrevDestMarker(i);var o=Ti.App.Android.R.drawable.marker_tap_long,a=addMarker(i,n,o);Ti.App.Properties.setInt("dest",a)}})}function removePrevDestMarker(e){0!==Ti.App.Properties.getInt("dest")&&e.removeLayer(Ti.App.Properties.getInt("dest"));var i=Ti.App.Properties.getString("RouteMarkers");if(!(i.length<1))for(var t=JSON.parse(i),r=0;r<t.length;r++)e.removeLayer(t[r])}function addMarker(e,i,t){var r=e.createMarker({iconPath:t,latlng:i});return r.id}function addNodeMarkers(){for(var e=getNodes(),i=JSON.parse(e),t=[],r=0;r<i.length;r++){var n=i[r].pts[0],o=[n[1],n[0]],a=Ti.App.Android.R.drawable.point_red,p=addMarker(map,o,a);t.push(p)}Ti.App.Properties.setString("RouteMarkers",JSON.stringify(t))}function navi(e,i,t,r){var n={weighting:"fastest",vehicle:"foot",from:t,to:r};e.getRouteAsyncCallback(n,function(e){if(0==e.error){var t=Ti.App.Properties.getInt("route");0!==t&&i.removeLayer(t);var r=i.createPolyline({latlngs:e.pts,color:"blue",strokeWidth:10});Ti.App.Properties.setInt("route",r.id),Ti.App.Properties.setString("Nodes",JSON.stringify(e.nodes)),addNodeMarkers(),Ti.API.info("getRouteAsyncCallback().addNodeMarkers() done"),Ti.App.Properties.setInt("MODE",1),win.setKeepScreenOn(!0)}else Ti.API.info("navi error:"+e.error)})}initVars();var win=initWindow();initWindowEvent(win);var mf=initModule(),map=initMap(win,mf);initMapListener(win,mf,map),initNav(mf);