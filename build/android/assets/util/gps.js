function getCurrentPosDict(){return{lat:Ti.App.Properties.getDouble("gps_lat"),lng:Ti.App.Properties.getDouble("gps_lng")}}function getCurrentPos(){return[Ti.App.Properties.getDouble("gps_lat",0),Ti.App.Properties.getDouble("gps_lng",0)]}function saveGpsData(e){Ti.App.Properties.setDouble("gps_lng",e.coords.longitude),Ti.App.Properties.setDouble("gps_lat",e.coords.latitude),Ti.App.Properties.setInt("heading",e.coords.heading),Ti.App.Properties.setInt("gps_accuracy",e.coords.accuracy),Ti.App.Properties.setInt("speed",e.coords.speed)}function naviOrNot(e){var t=Ti.App.Properties.getInt("MODE");return e.length<1||0==t?!1:!0}function hint(e,t,i){var a=i.pts[0],o=distance(e[0],e[1],a[1],a[0]);instruction(t,i,o)}function getRange(e){return GPS_RANGE_MIN>e?GPS_RANGE_MIN:e}function drawMyLocMarker(e,t){isGoogleMap()||addMyLocMarker(e,t)}function locationCallback(e){if(!e.error){saveGpsData(e);var t=[e.coords.latitude,e.coords.longitude];drawMyLocMarker(t,e.coords.accuracy);var i=getNodes();if(naviOrNot(i)){var a=JSON.parse(i);animateTo(t);var o=checkOnRoad(a,t,e.coords.accuracy);if(o>-1){var r=findNextNode(a,o);hint(t,o,r)}else reroute()}}}function checkOnRoad(e,t,i){var a=getRange(i),o=findMyStepId(e,t,a);return 0>o&&(o=findMyStepId(e,t,a+50)),o}function reroute(){if(!ROUTING){removePrevAll();var e=getCurrentPos(),t=getDestinatePos();navi(navimodule,e,t)}}function findNextNode(e,t){return t+1<e.length?e[t+1]:e[t]}function findMyStepId(e,t,i){for(var a=JSON.stringify(t),o=-1,r=0;r<e.length;r++){var n=checkStep(a,JSON.stringify(e[r].pts),i);if(n){o=r;break}}return o}function instruction(e,t,i){var a="";if(e>-1){var o=getGHDict(),r=100*Math.round(i/100),n=o[""+t.sign],s=!0;isPlayed(e,r)||(Ti.API.info("dist="+r+",stepId="+e+" turn="+n+", nextNode:"+JSON.stringify(t)),s=speakInterface(r,n,t.name),s&&setPlayedList(e,r)),a="step "+e+", "+r+"m("+i+"), turn "+n+", on "+t.name+", play="+s}else a=i>0?"dist="+i+",but not in any step":"not in any step";var l=Titanium.UI.createNotification({duration:Ti.UI.NOTIFICATION_DURATION_SHORT,message:a});l.show()}function checkStep(e,t,i){var a=navimodule.isInStep({range:i,point:e,points:t});return a}function addMyLocMarker(e,t){var i=Ti.App.Properties.getInt("mySpot"),a=Ti.App.Properties.getInt("myCircle");if(0!==a||0!==i)updateCircle(a,e,t),updateMarker(i,e);else{var o=addCircleMF(e,t,"#33000099"),r=addMarkerMF(e,Ti.App.Android.R.drawable.me_point_blue_1);Ti.App.Properties.setInt("mySpot",r),Ti.App.Properties.setInt("myCircle",o)}}function removeHandler(){Ti.API.info("removeHandler gps"),Ti.Geolocation.Android.removeEventListener("location",locationCallback)}function initGPS(){Ti.Geolocation.Android.manualMode=!0;var e=Ti.Geolocation.Android.createLocationProvider({name:Ti.Geolocation.PROVIDER_GPS,minUpdateTime:"2"});Ti.Geolocation.Android.addLocationProvider(e);var t=Ti.Geolocation.Android.createLocationRule({provider:Ti.Geolocation.PROVIDER_GPS,maxAge:3e3,minAge:2e3});Ti.Geolocation.Android.addLocationRule(t);var i=Ti.Geolocation.Android.createLocationProvider({name:Ti.Geolocation.PROVIDER_NETWORK});Ti.Geolocation.Android.addLocationProvider(i);var a=Ti.Geolocation.Android.createLocationRule({provider:Ti.Geolocation.PROVIDER_NETWORK,accuracy:20,maxAge:3e3,minAge:2e3});Ti.Geolocation.Android.addLocationRule(a),Ti.Geolocation.locationServicesEnabled?(Ti.API.info("gps enabled"),Ti.Geolocation.addEventListener("location",locationCallback)):alert("Please enable location services")}function distance(e,t,i,a){var o=6371,r=.5-Math.cos((i-e)*Math.PI/180)/2+Math.cos(e*Math.PI/180)*Math.cos(i*Math.PI/180)*(1-Math.cos((a-t)*Math.PI/180))/2,n=2*o*Math.asin(Math.sqrt(r))*1e3;return n.toFixed(0)}var locationAdded=!1,GPS_RANGE_MIN=30,GPS_RANGE_MAX=200,GPS_RANGE=GPS_RANGE_MIN;