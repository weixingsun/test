function handleLocation(e){if(!e.error){Ti.App.Properties.setDouble("lng",e.coords.longitude),Ti.App.Properties.setDouble("lat",e.coords.latitude),Ti.App.Properties.setInt("heading",e.coords.heading),Ti.App.Properties.setInt("accuracy",e.coords.accuracy),Ti.App.Properties.setInt("speed",e.coords.speed);var i=[e.coords.latitude,e.coords.longitude];addMyLocMarker(i,e.coords.accuracy);var t=JSON.stringify(i),r=Ti.App.Properties.getString("Nodes");if(r.length<1)return;for(var n=JSON.parse(r),o=-1,a=0;a<n.length;a++){var p=JSON.stringify(n[a].pts),d=checkStep(t,p);if(d){o=a;break}}showToast(o)}}function showToast(e){Ti.API.info("showToast");var i="";i=e>-1?"in step "+e:"not in any step";var t=Titanium.UI.createNotification({duration:Ti.UI.NOTIFICATION_DURATION_SHORT,message:i});t.show()}function checkStep(e,i){var t=mf.isInStep({range:80,point:e,points:i});return t}function addMyLocMarker(e,i){0!==Ti.App.Properties.getInt("myCircle")&&map.removeLayer(Ti.App.Properties.getInt("myCircle")),0!==Ti.App.Properties.getInt("mySpot")&&map.removeLayer(Ti.App.Properties.getInt("mySpot"));var t=map.createCircle({latlng:e,colorHex:"#33000099",radius:i}),r=map.createMarker({iconPath:Ti.App.Android.R.drawable.me_point_blue_1,latlng:e});Ti.App.Properties.setInt("mySpot",r.id),Ti.App.Properties.setInt("myCircle",t.id)}function addHandler(){locationAdded||(Ti.API.info("setup gps handler 2"),Ti.Geolocation.addEventListener("location",handleLocation),locationAdded=!0)}function removeHandler(){locationAdded&&(Ti.API.info("removeHandler gps"),Ti.Geolocation.removeEventListener("location",handleLocation),locationAdded=!1)}function initGPS(){Ti.Geolocation.accuracy=Ti.Geolocation.ACCURACY_BEST,Ti.Geolocation.distanceFilter=100,Ti.Geolocation.preferredProvider=Ti.Geolocation.PROVIDER_GPS,Ti.Geolocation.locationServicesEnabled?(Ti.API.info("setup gps handler 1"),addHandler()):alert("Please enable location services")}var locationAdded=!1;