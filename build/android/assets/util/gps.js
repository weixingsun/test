function getCurrentPosDict(){return{lat:Ti.App.Properties.getDouble("gps_lat"),lng:Ti.App.Properties.getDouble("gps_lng")}}function getCurrentPos(){return[Ti.App.Properties.getDouble("gps_lat",0),Ti.App.Properties.getDouble("gps_lng",0)]}function saveGpsData(e){Ti.App.Properties.setDouble("gps_lng",e.coords.longitude),Ti.App.Properties.setDouble("gps_lat",e.coords.latitude),Ti.App.Properties.setInt("heading",e.coords.heading),Ti.App.Properties.setInt("gps_accuracy",e.coords.accuracy),Ti.App.Properties.setInt("speed",e.coords.speed)}function naviOrNot(e){var i=Ti.App.Properties.getInt("MODE");return e.length<1||0==i?!1:!0}function hint(e,i,t){var n=t.pts[0],a=distance(e[0],e[1],n[1],n[0]);instruction(i,t,a)}function getRange(e){return GPS_RANGE_MIN>e?GPS_RANGE_MIN:e}function drawMyLocMarker(e,i){isGoogleMap()||addMyLocMarker(e,i)}function locationCallback(e){if(!e.error){saveGpsData(e);var i=[e.coords.latitude,e.coords.longitude];drawMyLocMarker(i,e.coords.accuracy);var t=getNodes();if(naviOrNot(t)){var n=JSON.parse(t);animateTo(i);var a=checkOnRoad(n,i,e.coords.accuracy);if(a>-1){var o=findNextNode(n,a);hint(i,a,o)}else reroute()}}}function checkOnRoad(e,i,t){var n=getRange(t),a=findMyStepId(e,i,n);return 0>a&&(a=findMyStepId(e,i,n+50)),a}function reroute(){if(!ROUTING){removePrevAll();var e=getCurrentPos(),i=getDestinatePos();navi(navimodule,e,i)}}function findNextNode(e,i){return i+1<e.length?e[i+1]:e[i]}function findMyStepId(e,i,t){for(var n=JSON.stringify(i),a=-1,o=0;o<e.length;o++){var r=checkStep(n,JSON.stringify(e[o].pts),t);if(r){a=o;break}}return a}function instruction(e,i,t){var n="";if(e>-1){var a=getGHDict(),o=100*Math.round(t/100),r=a[""+i.sign],l=!0;if(!isPlayed(e,o)){Ti.API.info("dist="+o+",stepId="+e+" turn="+r+", nextNode:"+JSON.stringify(i));var d="in "+o+" meters, "+r+", on "+i.name,c="en_US";speakLib(d,c),l&&setPlayedList(e,o)}n="step "+e+", "+o+"m("+t+"), turn "+r+", on "+i.name+", play="+l}else n=t>0?"dist="+t+",but not in any step":"not in any step";var s=Titanium.UI.createNotification({duration:Ti.UI.NOTIFICATION_DURATION_SHORT,message:n});s.show()}function checkStep(e,i,t){var n=navimodule.isInStep({range:t,point:e,points:i});return n}function addMyLocMarker(e,i){var t=Ti.App.Properties.getInt("mySpot"),n=Ti.App.Properties.getInt("myCircle");if(0!==n||0!==t)updateCircle(n,e,i),updateMarker(t,e),Ti.API.info("updating my loc");else{var a=addCircleMF(e,i,"#33000099"),o=addMarkerMF(e,Ti.App.Android.R.drawable.me_point_blue_1);Ti.App.Properties.setInt("mySpot",o),Ti.App.Properties.setInt("myCircle",a),Ti.API.info("creating my loc mk:"+o+",cc:"+a)}}function removeHandler(){Ti.API.info("removeHandler gps"),Ti.Geolocation.Android.removeEventListener("location",locationCallback)}function initGPS(){Ti.Geolocation.Android.manualMode=!0;var e=Ti.Geolocation.Android.createLocationProvider({name:Ti.Geolocation.PROVIDER_GPS,minUpdateTime:"2"});Ti.Geolocation.Android.addLocationProvider(e);var i=Ti.Geolocation.Android.createLocationRule({provider:Ti.Geolocation.PROVIDER_GPS,maxAge:3e3,minAge:2e3});Ti.Geolocation.Android.addLocationRule(i);var t=Ti.Geolocation.Android.createLocationProvider({name:Ti.Geolocation.PROVIDER_NETWORK});Ti.Geolocation.Android.addLocationProvider(t);var n=Ti.Geolocation.Android.createLocationRule({provider:Ti.Geolocation.PROVIDER_NETWORK,accuracy:20,maxAge:3e3,minAge:2e3});Ti.Geolocation.Android.addLocationRule(n),Ti.Geolocation.locationServicesEnabled?(Ti.API.info("gps enabled"),Ti.Geolocation.addEventListener("location",locationCallback)):alert("Please enable location services")}function distance(e,i,t,n){var a=6371,o=.5-Math.cos((t-e)*Math.PI/180)/2+Math.cos(e*Math.PI/180)*Math.cos(t*Math.PI/180)*(1-Math.cos((n-i)*Math.PI/180))/2,r=2*a*Math.asin(Math.sqrt(o))*1e3;return r.toFixed(0)}var locationAdded=!1,GPS_RANGE_MIN=30,GPS_RANGE_MAX=200,GPS_RANGE=GPS_RANGE_MIN;